<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="zh-tw">
	<head>
		<meta charset="utf-8">
		<meta name="google-signin-client_id" content="65164552845-kt5nqknig8520gtv3o66aqej0t5a2pfp.apps.googleusercontent.com">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="">
		<meta name="author" content="">
		<!-- Bootstrap core CSS -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css">
		<link rel="stylesheet" href="/css/style.css">
		<!-- Bootstrap core JavaScript -->
		<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/extensions/multiple-search/bootstrap-table-multiple-search.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/locale/bootstrap-table-zh-TW.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/locale/bootstrap-table-zh-TW.min.js"></script>
	</head>
	<body>
		<div class="load_modal"></div>
		<div class="login_container">
			<div class="login_icon" id="my-signin2"></div>
			<div class="login_id align_left"><p id="user_title">Guest</p></div>
		</div>
		<datalist id="part_list"></datalist>
		<div class="table_container">
			<ul class="nav nav-tabs">
				<li class="active"><a data-toggle="tab" href="#home">查詢</a></li>
				<li><a data-toggle="tab" href="#menu1">新增料件</a></li>
				<li><a data-toggle="tab" href="#menu2">新增材料</a></li>
				<li><a data-toggle="tab" href="#menu3">修改</a></li>
				<li><a data-toggle="tab" href="#menu4">入庫&領用</a></li>
				<li><a data-toggle="tab" href="#menu5">BOM</a></li>
				<li><a data-toggle="tab" href="#menu6">紀錄</a></li>
			</ul>
			<div class="tab-content">
				<div id="home" class="tab-pane fade in active">
					<div class="col-xs-3 btn_field">
						<button type="button" class="btn btn-primary" onclick="receive_db_info()" >更新數據</button>
					</div>
					<table id="part_table"
						data-toggle="table"
						data-side-pagination="client"
						data-pagination="true"
						data-height="525"
						data-page-list="[5, 10, 50, 100]"
						data-search="true"
						data-id-field="index"
						data-unique-id="index"
						data-show-columns="true"
						data-page-number="1">
						<thead>
							<tr>
								<th data-field="index">項次</th>
								<th data-field="number">品號</th>
								<th data-field="name">品名</th>
								<th data-field="format">規格</th>
								<th data-field="fignum">圖號</th>
								<th data-field="supplier">廠商</th>
								<th data-field="unit">單位</th>
								<th data-field="stock_quantity">庫存數量</th>
								<th data-field="cost">單位成本</th>
								<th data-field="stock_amount">庫存金額</th>
							</tr>
						</thead>
					</table>
				</div>
				<div id="menu1" class="tab-pane fade">
					<div class= "tab_form">
						<div class="text_field">
							<label for="part_num_in">品號 :</label><input class="numtext input_container" type=text name=part_num1 size="1" maxlength="1" placeholder="1" style="text-transform:uppercase" onchange="check_part_num(3,1,this.value)" >
							<b>－</b><input class="numtext input_container" type=text name=part_num2 size="2" maxlength="2" placeholder="AA" style="text-transform:uppercase" onchange="check_part_num(2,2,this.value)" >
							<b>－</b><input class="numtext input_container" type=text name=part_num3 size="3" maxlength="3" placeholder="AAA" style="text-transform:uppercase" onchange="check_part_num(2,3,this.value)" >
							<b>－</b><input class="numtext input_container" type=text name=part_num4 size="3" maxlength="3" placeholder="AAA" style="text-transform:uppercase" onchange="check_part_num(2,3,this.value)" >
							<b>－</b><input class="numtext input_container" type=text name=part_num5 size="3" maxlength="3" placeholder="000" style="text-transform:uppercase" onchange="check_part_num(1,3,this.value)" >
							<b>－</b><input class="numtext input_container" type=text name=part_num6 size="3" maxlength="3" placeholder="000" style="text-transform:uppercase" onchange="check_part_num(1,3,this.value)" >
							<br><label for="part_name_in">品名 :</label><input id="part_name_in" class="part_attr input_container" name="part_name" type="text" style="width:300px" />
							<br><label for="part_format_in">規格 :</label><input id="part_format_in" class="part_attr input_container" name="part_format" type="text" style="width:500px" />
							<br><label for="part_fignum_in">圖號 :</label><input id="part_fignum_in" class="part_attr input_container" name="part_fignum" type="text" style="width:250px" />
							<br><label for="part_supplier_in">廠商 :</label><input id="part_supplier_in" class="part_attr input_container" name="part_supplier" type="text" style="width:100px" />
							<br><label for="part_unit_in">單位 :</label><select id="part_unit_in" class="part_attr input_container" name="part_unit" style="width:70px" ><option value="set">SET</option><option value="set">PCS</option></select>
							<br><label for="part_cost_in">成本 :</label><input id="part_cost_in" class="part_attr input_container" name="part_cost" type="text" style="width:100px" />
						</div>
						<div class="btn_field">
							<button type="button" class="btn btn-primary" onclick="send_new_part()" >新增</button>
						</div>
					</div>
				</div>
				<div id="menu2" class="tab-pane fade">
					<div class= "tab_form">
						<div class="text_field" >
							<label for="part_num_in">品號 :</label><input class="numtext input_container" type=text name=part_num1 size="1" maxlength="1" placeholder="1" style="text-transform:uppercase" onchange="check_part_num(3,1,this.value)" >
							<b>－</b><input class="numtext input_container" type=text name=part_num2 size="2" maxlength="2" placeholder="AA" style="text-transform:uppercase" onchange="check_part_num(2,2,this.value)" >
							<b>－</b><input class="numtext input_container" type=text name=part_num3 size="3" maxlength="3" placeholder="AAA" style="text-transform:uppercase" onchange="check_part_num(2,3,this.value)" >
							<b>－</b><input class="numtext input_container" type=text name=part_num4 size="3" maxlength="3" placeholder="AAA" style="text-transform:uppercase" onchange="check_part_num(2,3,this.value)" >
							<b>－</b><input class="numtext input_container" type=text name=part_num5 size="3" maxlength="3" placeholder="000" style="text-transform:uppercase" onchange="check_part_num(1,3,this.value)" >
							<b>－</b><input class="numtext input_container" type=text name=part_num6 size="3" maxlength="3" placeholder="000" style="text-transform:uppercase" onchange="check_part_num(1,3,this.value)" >
							<br><label for="part_name_in">品名 :</label><input id="part_name_in" class="part_attr input_container" name="part_name" type="text" style="width:300px" />
							<br><label for="part_remark_in">備註 : </label>
							<br><textarea id="part_remark_in" class="part_attr" name="part_remark" rows="5" cols="50" wrap="hard" ></textarea>
							<br><div class="col-xs-2" style="margin-top:5px;margin-bottom:5px" >
								<button type="button" class="col-xs-12 btn btn-primary" onclick='append_btn_res()' >Add Item</button>
							</div>
							<div class="col-xs-2" style="margin-top:5px;margin-bottom:5px" >
								<button type="button" class="col-xs-12 btn btn-primary" onclick='send_new_product()' >Upload</button>
							</div>
							<div class="col-xs-8 align_right">
								<label for="part_totalcost_out">總成本 :</label><input type=text id="part_totalcost_out" class="part_attr input_container" style="width:200px;margin-top:15px" name="part_totalcost" disabled="true" >
							</div>
							<table id="product_table_add"
								data-toggle="table"
								data-side-pagination="client"
								data-pagination="false"
								data-height="525"
								data-id-field="index"
								data-unique-id="index">
								<thead>
									<tr>
										<th data-field="index">項次</th>
										<th data-field="number" data-formatter="edit_partnum">品號</th>
										<th data-field="name">品名</th>
										<th data-field="quantity" data-formatter="edit_quan">數量</th>
										<th data-field="cost">單位成本</th>
										<th data-field="totalcost">成本加總</th>
										<th data-field="supplier">廠商</th>
										<th data-field="format">規格</th>
										<th data-field="delrow" data-formatter="formatter_delbtn">刪除</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
				<div id="menu3" class="tab-pane fade">
					<div id="revise_title" style="display:none">
						<table id="revise_table"
							data-toggle="table"
							data-side-pagination="client"
							data-pagination="false"
							data-visible = "false"
							data-height="525"
							data-id-field="index"
							data-unique-id="index" >
							<thead>
								<tr>
									<th data-field="index">項次</th>
									<th data-field="number" data-formatter="edit_partnum">品號</th>
									<th data-field="name">品名</th>
									<th data-field="quantity" data-formatter="edit_quan">數量</th>
									<th data-field="cost">單位成本</th>
									<th data-field="totalcost">成本加總</th>
									<th data-field="supplier">廠商</th>
									<th data-field="format">規格</th>
									<th data-field="delrow" data-formatter="formatter_delbtn">刪除</th>
								</tr>
							</thead>
						</table>
					</div>
				</div>
				<div id="menu4" class="tab-pane fade">
					<div class= "tab_form">
						<div class="text_field">
							<label for="part_num_in">品號 :</label><input id="part_num_in" class="part_attr part_list_style input_container" name="part_num_list" list="part_list" onchange="receive_part_info('quantity', this.value )" />
							<br><label for="part_inventory_out">庫存 :</label><input id="part_inventory_out" class="part_attr input_container" name="inventory" type="number" style="width:100px" disabled="true" value="0" />
							<br><label for="part_variable_in">變量 :</label><input id="part_variable_in" class="part_attr input_container" name="part_varval" type="number" style="width:100px" value="0" />
							<br><label for="part_location_in">位置 :</label><input id="part_location_in" class="part_attr input_container" name="part_location" type="text" style="width:200px" placeholder="湖口" />
							<br><label for="part_goal_in">目的 : </label>
							<br><textarea id="part_goal_in" class="part_attr" name="part_goal" rows="5" cols="50" wrap="hard" ></textarea>
							<br><button type="button" class="btn btn-primary btn_field" onclick="send_inventory_quantity('add')">入庫</button>
							<button type="button" class="btn btn-primary btn_field" onclick="send_inventory_quantity('sub')">領用</button>
						</div>
					</div>
				</div>
				<div id="menu5" class="tab-pane fade">
				</div>
				<div id="menu6" class="tab-pane fade">
					<div class="col-xs-2 btn_field">
						<button type="button" class="btn btn-primary" onclick="delete_record()" >刪除</button>
					</div>
					<div class="col-xs-2 btn_field">
						<button type="button" class="btn btn-primary" onclick="receive_record()" >更新數據</button>
					</div>
					<table id="record_table"
						data-toggle="table"
						data-side-pagination="client"
						data-pagination="true"
						data-page-list="[5, 10, 50, 100]"
						data-search="true"
						data-height="525"
						data-id-field="index"
						data-unique-id="index"
						data-show-columns="true"
						data-page-number="1">
						<thead>
							<tr>
								<th data-field="state" data-checkbox="true"></th>
								<th data-field="index">項次</th>
								<th data-field="timestamp">時間</th>
								<th data-field="number">品號</th>
								<th data-field="action">行為</th>
								<th data-field="quantity">數量</th>
								<th data-field="goal">目的</th>
								<th data-field="location">位置</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
    <script language="JavaScript">
		var body = $("body");
		var product_table = $("#part_table");
		var ele_id;
		var user_id = "";
		var part_list_obj = $("#part_list");
		var part_list_options = "";
		var bom_node_array = new Array();
		var window = {
			"product_table": product_table,
			"ele_id": ele_id,
			"user_id": user_id,
			"part_list_obj": part_list_obj,
			"part_list_options": part_list_options,
			"bom_node_array": bom_node_array
		}
		/*loading event*/
		$(document).on({
			ajaxStart: function() { body.addClass("loading"); },
			ajaxStop: function() { body.removeClass("loading"); }
		});

		$(document).ready(function(){
			/*show tab*/
			$(".nav-tabs a").click(function(){
				$(this).tab('show');
			});
			
			/*tab response*/
		    $('.nav-tabs a').on('shown.bs.tab', function(event){
				var x = $(event.target).text();   // active tab
				switch(x){
					case "查詢":
						product_table = $("#part_table"); 
						ele_id = "home";
						test_window();
						break;
					case "新增料件":
						ele_id = "menu1";
						test_window();
						break;
					case "新增材料":
						product_table = $("#product_table_add"); 
						ele_id = "menu2";
						test_window();
						break;
					case "修改":
						product_table = $("#revise_table");
						ele_id = "menu3";
						init_revise_interface();
						break;
					case "入庫&領用":
						ele_id = "menu4";
						break;
					case "BOM":
						ele_id = "menu5";
						init_bomtable_interface( ele_id );
						break;
					case "紀錄":
						product_table = $("#record_table");
						ele_id = "menu6";
						test_window();
						receive_record();
						break;
					default:
				}
			});
		});
		
		// table formatter delete button
		function formatter_delbtn( val, row, index ){
			return ("<button class='delbtn btn btn-danger glyphicon glyphicon-remove row-remove' onclick='remove_table_row( product_table , " + index + ")'></button>");
		}
		
		/* table part quantity sub function */
		function edit_quan( param, row, index ){
			if(param.func == 1){
				return ("<p onclick='change_quan_type(" + index + "," + param.val + ", 2)'>" + param.val + "</p>");
			}
			else if(param.func == 2){
				return ("<input type='number' size='3' onchange='update_total_cost( " + index + ", this.value )' onblur='change_quan_type(" + index + ",this.value, 1)' value='" + param.val + "'/>");
			}
		}
			
		function change_quan_type( idx, val, change_func ){
			if ( isNaN( parseInt( val ) ) ){
				val = 0;
			}
			var quan_param ={
				func: change_func,
				val: val
			};
			product_table.bootstrapTable('updateRow', {
				index: idx,
				row: {
					quantity: quan_param
				}
			});	
		}

		/* calculate total cost and update */	
		function update_total_cost( idx, val ){
			var attr = product_table.bootstrapTable('getRowByUniqueId', idx );
			if ( isNaN( parseInt( val ) ) ){
				val = 0;
			}
			
			if( typeof attr.cost !== "number"){
				attr.cost = 0;
			}
			var quan_param ={
				func: 1,
				val: val
			};
			product_table.bootstrapTable('updateRow', {
				index: idx,
				row: {
					quantity: quan_param,
					totalcost: attr.cost * val,
				}
			});
			data_attr = product_table.bootstrapTable("getData",false);
			var product_cost = 0;
			var value = 0;
			for( var i = 0; i<data_attr.length; i++ ){
				value = parseFloat( data_attr[i].totalcost );
				if( isNaN(value) ){
					value = 0;
				}
				product_cost += value;
			}
			var cnt = document.getElementById( ele_id );
			var part_attr = cnt.getElementsByClassName("part_attr");
			for( var i=0; i<part_attr.length; i++ ){
				if( part_attr[i].name == "part_totalcost" ){
					part_attr[i].value = product_cost;
				}
			}
		}
		
		
		
		/* table part number sub function */
		function edit_partnum( param, row, index ){
			if(param.func == 1){
				return ("<pre onclick='change_partnum_type_static(" + index + ")'>" + param.val + "</pre>");
			}
			else if(param.func == 2){
				return ("<input list='part_list' class='part_list_style' onchange='receive_product_param(" + index + ",this.value)' onblur='change_partnum_type_dynamic(" + index + ",this.value)' value=" + param.val + " ><datalist>" + part_list_options + "</datalist>");
			}
		}
		
		function change_partnum_type_static( idx, source_val ){
			var param = product_table.bootstrapTable( 'getRowByUniqueId', idx );
			if(param.number.val == "undefined"){
				param_val = "";
			}
			else{
				param_val = param.number.val;
			}
			var num_param ={
				func: 2,
				val: param_val
			};
			product_table.bootstrapTable('updateRow', {
				index: idx,
				row: {
					number: num_param
				}
			});
		}
		
		function change_partnum_type_dynamic( idx, source_val ){
			var num_param ={
				func: 1,
				val: source_val
			};
			product_table.bootstrapTable('updateRow', {
				index: idx,
				row: {
					number: num_param
				}
			});
		}


		

		
		// google login render icon
		function renderButton(){
			gapi.signin2.render('my-signin2', {
				'scope': 'profile email',
				'width': 180,
				'height': 32,
				'longtitle': true,
				'theme': 'dark',
				'onsuccess': onSuccess,
				'onfailure': onFailure
			});
		};

		// google login event
		function onSuccess(googleUser){
			user_email = googleUser.getBasicProfile().getEmail();
			user_id = user_email.substring( 0, user_email.indexOf("@") );
			user_name = googleUser.getBasicProfile().getName();
			console.log('Logged in as: ' + user_email + user_id );
			document.getElementById("user_title").innerHTML = "Hello"+ " " + user_name;
			receive_db_info();
		};

		// google login failure report
		function onFailure(error){
			alert(error);
		};
		
    </script>
	<script type="text/javascript" src="/scripts/bom_table.js"></script>
	<script type="text/javascript" src="/scripts/database.js"></script>
	<script type="text/javascript" src="/scripts/get_doc_part_attr.js"></script>
	<script type="text/javascript" src="/scripts/part_number.js"></script>
	<script type="text/javascript" src="/scripts/record.js"></script>
	<script type="text/javascript" src="/scripts/revise.js"></script>
	<script type="text/javascript" src="/scripts/receive.js"></script>
	<script type="text/javascript" src="/scripts/send.js"></script>
	<script type="text/javascript" src="/scripts/table_row_ctrl.js"></script>
	<script type="text/javascript" src="/scripts/test.js"></script>
    <script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script>
  </body>
</html>